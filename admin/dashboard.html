<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Master Cake Admin ‚Äî Dashboard</title>
  <link rel="icon" href="../Logo.png">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #e01f2d;
      --primary-dark: #b31422;
      --secondary: #0a7a3d;
      --bg-main: #fafbfc;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo {
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .header-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    /* Navigation Tabs */
    .nav-tabs {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .nav-tabs-content {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      min-width: max-content;
    }

    .nav-tab {
      padding: var(--spacing-md) var(--spacing-lg);
      border: none;
      background: none;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: var(--border-light);
    }

    .nav-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Main Content */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-lg) var(--spacing-md);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
    }

    .card-header {
      padding: var(--spacing-lg) var(--spacing-lg) var(--spacing-md);
      border-bottom: 1px solid var(--border-light);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .card-content {
      padding: var(--spacing-lg);
    }

    .card-footer {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--border-light);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-grid {
      display: grid;
      gap: var(--spacing-md);
      grid-template-columns: 1fr;
    }

    .file-input-group{ display:flex; gap:var(--spacing-sm); align-items:center; flex-wrap:wrap }
    .checkbox-label{ display:inline-flex; align-items:center; gap:8px; margin-top:6px; user-select:none }
    .checkbox-label input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--primary); }

    .form-row {
      display: grid;
      gap: var(--spacing-md);
      grid-template-columns: 1fr;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: var(--spacing-xs);
      color: var(--text-primary);
    }

    .label-with-button {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xs);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 16px;
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(224, 31, 45, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--text-secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--text-primary);
    }

    .btn-success {
      background: var(--secondary);
      color: white;
    }

    .btn-success:hover {
      background: #065a2e;
    }

    .btn-danger {
      background: var(--primary-dark);
      color: white;
    }

    .btn-danger:hover {
      background: #8b0f1a;
    }

    .btn-outline {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      background: var(--border-light);
      color: var(--text-primary);
    }

    .btn-group {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    /* Section Selector */
    .section-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .section-btn {
      padding: var(--spacing-md);
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: capitalize;
    }

    .section-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .section-btn.active {
      border-color: var(--primary);
      background: rgba(224, 31, 45, 0.05);
      color: var(--primary);
    }

    /* Items Grid */
    .items-grid {
      display: grid;
      gap: var(--spacing-md);
      grid-template-columns: 1fr;
    }

    .item-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .item-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    .item-card.selected {
      border-color: var(--primary);
      background: rgba(224, 31, 45, 0.02);
      box-shadow: var(--shadow-md);
    }

    .item-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .item-id {
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.875rem;
      flex: 1;
    }

    .item-price {
      background: var(--border-light);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--secondary);
    }

    .item-names {
      margin-bottom: var(--spacing-xs);
    }

    .item-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .item-name.ar {
      direction: rtl;
      text-align: right;
    }

    .item-images {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Messages */
    .message {
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      margin-top: var(--spacing-md);
    }

    .message.success {
      background: rgba(10, 122, 61, 0.1);
      color: var(--secondary);
      border: 1px solid rgba(10, 122, 61, 0.2);
    }

    .message.error {
      background: rgba(179, 20, 34, 0.1);
      color: var(--primary-dark);
      border: 1px solid rgba(179, 20, 34, 0.2);
    }

    .message.info {
      background: rgba(107, 114, 128, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(107, 114, 128, 0.2);
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: var(--spacing-xl);
      text-align: center;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: rgba(224, 31, 45, 0.02);
    }

    .upload-zone.dragover {
      border-color: var(--primary);
      background: rgba(224, 31, 45, 0.05);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      gap: var(--spacing-md);
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: var(--spacing-lg);
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: var(--spacing-lg);
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--spacing-xs);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Responsive Design */
    @media (min-width: 640px) {
      .form-row {
        grid-template-columns: 1fr 1fr;
      }
      
      .items-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
    }

    @media (min-width: 768px) {
      .main {
        padding: var(--spacing-xl) var(--spacing-lg);
      }
      
      .form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (min-width: 1024px) {
      .header-content {
        padding: var(--spacing-lg) var(--spacing-xl);
      }
      
      .main {
        padding: var(--spacing-xl);
      }
    }

    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
      position: relative;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Utilities */
    .hidden { display: none; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .mt-4 { margin-top: var(--spacing-md); }
    .mb-4 { margin-bottom: var(--spacing-md); }
    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        üßÅ Master Cake Admin
      </div>
      <div class="header-actions">
        <a href="/" target="_blank" class="btn btn-outline">View Site</a>
        <button id="btnLogout" class="btn btn-secondary">Logout</button>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="nav-tabs">
    <div class="nav-tabs-content">
      <button class="nav-tab active" data-tab="overview">üìä Overview</button>
      <button class="nav-tab" data-tab="items">üìã Menu Items</button>
      <button class="nav-tab" data-tab="editor">‚úèÔ∏è Item Editor</button>
      <button class="nav-tab" data-tab="upload">üìÅ Upload Images</button>
      <button class="nav-tab" data-tab="sections">üóÇÔ∏è Sections</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">
    <!-- Overview Tab -->
    <div class="tab-content active" id="overview">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalItems">0</div>
          <div class="stat-label">Total Items</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalSections">5</div>
          <div class="stat-label">Sections</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentUploads">0</div>
          <div class="stat-label">Recent Uploads</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Quick Actions</h2>
          <p class="card-description">Common tasks to manage your menu</p>
        </div>
        <div class="card-content">
          <div class="btn-group">
            <button class="btn btn-primary" onclick="switchTab('items')">üìã Manage Items</button>
            <button class="btn btn-success" onclick="switchTab('editor')">‚úèÔ∏è Add New Item</button>
            <button class="btn btn-secondary" onclick="switchTab('upload')">üìÅ Upload Images</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sections Tab -->
    <div class="tab-content" id="sections">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Manage Sections</h2>
          <p class="card-description">Add, rename, or remove menu sections</p>
        </div>
        <div class="card-content">
          <div class="form-grid">
            <div class="form-group">
              <label>Existing Sections</label>
              <div id="sectionsList"></div>
            </div>
            <div class="form-group">
              <label>New Section Key (e.g. smoothies)</label>
              <input id="secKey" placeholder="letters, numbers, underscore" />
              <label>Arabic Label</label>
              <input id="secAr" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©" />
              <label>English Label</label>
              <input id="secEn" placeholder="Title in English" />
              <div class="btn-group" style="margin-top:8px">
                <button id="btnAddSection" class="btn btn-primary">‚ûï Add / Update</button>
                <button id="btnDeleteSection" class="btn btn-outline">üóëÔ∏è Delete</button>
              </div>
              <div id="secMsg" class="message hidden"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Menu Items Tab -->
    <div class="tab-content" id="items">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Menu Items</h2>
          <p class="card-description">Select a section to view and manage items</p>
        </div>
        <div class="card-content">
          <div class="section-selector" id="sectionSelector">
            <!-- Sections will be dynamically loaded here -->
          </div>

          <div id="itemsContainer">
            <div class="items-grid" id="itemsGrid"></div>
            <div class="empty-state hidden" id="emptyState">
              <p>No items found in this section</p>
              <button class="btn btn-primary mt-4" onclick="switchTab('editor')">Add First Item</button>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="btn-group">
            <button id="btnLoadSelected" class="btn btn-primary">Edit Selected</button>
            <button id="btnDeleteSelected" class="btn btn-danger">Delete Selected</button>
          </div>
          <div id="tableMsg" class="message hidden"></div>
        </div>
      </div>
    </div>

    <!-- Item Editor Tab -->
    <div class="tab-content" id="editor">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Add / Edit Item</h2>
          <p class="card-description">Create new items or edit existing ones</p>
        </div>
        <div class="card-content">
          <div class="form-grid">
            <div class="form-group">
              <label>Section</label>
              <select id="formSection">
                <!-- Sections will be dynamically loaded here -->
              </select>
            </div>
            <div class="form-group">
              <label>Item ID</label>
              <input id="formId" placeholder="e.g. iced-spanish-latte" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Arabic Name</label>
              <input id="formArName" dir="rtl" />
            </div>
            <div class="form-group">
              <label>English Name</label>
              <input id="formEnName" />
            </div>
          </div>

          <div class="form-group">
            <div class="label-with-button">
              <label>Arabic Description</label>
              <button id="btnSuggest" class="btn btn-success">ü§ñ AI Suggest</button>
            </div>
            <textarea id="formDescAr" dir="rtl" placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"></textarea>
          </div>

          <div class="form-group">
            <label>English Description</label>
            <textarea id="formDescEn" placeholder="Product description in English"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price</label>
              <input id="formPrice" placeholder="e.g. 3.50" />
            </div>
            <div class="form-group">
              <label>Badge (Optional)</label>
              <input id="formBadge" placeholder="e.g. NEW, ‚òÖ" />
            </div>
          </div>

          <div class="form-group">
            <label>Images</label>
            <div class="form-row">
              <input id="formImages" placeholder="Comma-separated filenames (e.g. item1.jpg, item2.jpg)" />
              <div class="file-input-group">
                <input id="formUploadFiles" type="file" multiple accept="image/*" />
                <label class="checkbox-label"><input type="checkbox" id="autoName" checked /> Auto‚Äëname by item ID</label>
              </div>
            </div>
            <div id="attachMsg" class="message hidden"></div>
          </div>
        </div>
        <div class="card-footer">
          <div class="btn-group">
            <button id="btnSave" class="btn btn-primary">üíæ Save Item</button>
            <button id="btnClearForm" class="btn btn-outline">üóëÔ∏è Clear Form</button>
          </div>
          <div id="saveMsg" class="message hidden"></div>
        </div>
      </div>
    </div>

    <!-- Upload Images Tab -->
    <div class="tab-content" id="upload">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Upload Images</h2>
          <p class="card-description">Upload images for your menu items</p>
        </div>
        <div class="card-content">
          <div class="form-group">
            <label>Target Section</label>
            <select id="uploadSection">
              <option value="cold_drinks">Cold Drinks</option>
              <option value="hot_drinks">Hot Drinks</option>
              <option value="sweets">Sweets</option>
              <option value="argillies">Argillies</option>
              <option value="ice_cream">Ice Cream</option>
            </select>
          </div>

          <div class="upload-zone" id="uploadZone">
            <div style="margin-bottom: 16px; font-size: 2rem;">üìÅ</div>
            <div style="font-weight: 500; margin-bottom: 8px;">Click to select images or drag & drop</div>
            <div style="font-size: 0.875rem; color: var(--text-muted);">Supports: JPG, PNG, GIF (Max 10MB each)</div>
            <input id="fileInput" type="file" multiple accept="image/*" style="display: none;" />
          </div>

          <div id="selectedFiles" class="mt-4 hidden">
            <h4 style="margin-bottom: 8px;">Selected Files:</h4>
            <div id="filesList"></div>
          </div>
        </div>
        <div class="card-footer">
          <div class="btn-group">
            <button id="btnUpload" class="btn btn-primary">üì§ Upload Images</button>
            <button id="btnClearFiles" class="btn btn-outline">Clear Selection</button>
          </div>
          <div id="uploadMsg" class="message hidden"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentManifest = {};
    let currentSection = null;
    let selectedItemId = null;

    // API helper
    async function api(path, opts = {}) {
      const res = await fetch(path, opts);
      if (!res.ok) {
        throw new Error((await res.text()) || 'Request failed');
      }
      return res.json();
    }

    // Show message
    function showMessage(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${type}`;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    // Tab switching
    function switchTab(tabName) {
      // Update nav tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName);
      });
    }

    // Initialize app
    async function init() {
      try {
        // Check auth
        const authCheck = await fetch('/api/admin/check');
        if (!authCheck.ok) {
          location.href = '/admin/';
          return;
        }

        // Load manifest
        currentManifest = await api('/api/admin/manifest');
        updateOverviewStats();
        renderSectionSelectors();
        renderItems();
        renderSectionsList();

        // Setup event listeners
        setupEventListeners();

      } catch (error) {
        console.error('Initialization failed:', error);
        showMessage('saveMsg', 'Failed to initialize dashboard', 'error');
      }
    }

    function setupEventListeners() {
      // Navigation tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Section selector - will be set up after sections are rendered
    }

      // Upload zone
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      uploadZone.addEventListener('click', () => fileInput.click());
      
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        updateSelectedFiles();
      });

      fileInput.addEventListener('change', updateSelectedFiles);

      // Form buttons
      document.getElementById('btnSave').addEventListener('click', saveItem);
      document.getElementById('btnSuggest').addEventListener('click', suggestWithAI);
      document.getElementById('btnClearForm').addEventListener('click', clearForm);
      document.getElementById('btnUpload').addEventListener('click', uploadImages);
      document.getElementById('btnClearFiles').addEventListener('click', clearFiles);
      document.getElementById('btnLoadSelected').addEventListener('click', loadSelectedItem);
      document.getElementById('btnDeleteSelected').addEventListener('click', deleteSelectedItem);
      document.getElementById('btnLogout').addEventListener('click', logout);

      // Sections
      const addBtn = document.getElementById('btnAddSection');
      const delBtn = document.getElementById('btnDeleteSection');
      if (addBtn) addBtn.addEventListener('click', addOrUpdateSection);
      if (delBtn) delBtn.addEventListener('click', deleteSection);

      // Attach uploads directly to the current item
      const formFiles = document.getElementById('formUploadFiles');
      if (formFiles) {
        const autoAttach = async () => {
          const section = document.getElementById('formSection').value;
          const itemId = document.getElementById('formId').value.trim();
          const auto = document.getElementById('autoName')?.checked ? '1' : '0';
          if (!itemId) { showMessage('attachMsg', '‚ùå Enter item ID first', 'error'); return; }
          if (!formFiles.files.length) { return; }
          const fd = new FormData();
          fd.append('section', section);
          fd.append('itemId', itemId);
          fd.append('autoname', auto);
          Array.from(formFiles.files).forEach(f => fd.append('files', f));
          const resp = await fetch('/api/admin/upload', { method: 'POST', body: fd });
          const data = await resp.json().catch(()=>null);
          if (resp.ok && data && Array.isArray(data.saved)) {
            const current = document.getElementById('formImages').value.split(',').map(s=>s.trim()).filter(Boolean);
            const merged = Array.from(new Set([...current, ...data.saved]));
            document.getElementById('formImages').value = merged.join(', ');
            showMessage('attachMsg', `‚úÖ Attached: ${data.saved.join(', ')}`, 'success');
            formFiles.value = '';
          } else {
            showMessage('attachMsg', '‚ùå Upload failed', 'error');
          }
        };
        formFiles.addEventListener('change', autoAttach);
      }
    }

    function updateOverviewStats() {
      let totalItems = 0;
      Object.values(currentManifest.sections || {}).forEach(section => {
        totalItems += (section.items || []).length;
      });
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalSections').textContent = Object.keys(currentManifest.sections || {}).length;
    }

    function renderItems() {
      if (!currentSection) return;
      
      const container = document.getElementById('itemsGrid');
      const emptyState = document.getElementById('emptyState');
      const items = currentManifest.sections?.[currentSection]?.items || [];

      if (items.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      emptyState.classList.add('hidden');

      container.innerHTML = items.map(item => `
        <div class="item-card" data-id="${item.id}">
          <div class="item-header">
            <div class="item-id">${item.id}</div>
            ${item.price ? `<div class="item-price">$${item.price}</div>` : ''}
          </div>
          <div class="item-names">
            ${item.arName ? `<div class="item-name ar">${item.arName}</div>` : ''}
            ${item.enName ? `<div class="item-name">${item.enName}</div>` : ''}
          </div>
          ${item.images?.length ? `<div class="item-images">üì∑ ${item.images.join(', ')}</div>` : ''}
        </div>
      `).join('');

      // Add click handlers
      container.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('click', () => {
          container.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedItemId = card.dataset.id;
        });
      });
    }

    function renderSectionsList() {
      const box = document.getElementById('sectionsList');
      if (!box) return;
      const secs = currentManifest.sections || {};
      box.innerHTML = Object.entries(secs).map(([key, val]) => `
        <div class="form-row" style="align-items:center">
          <div style=\"min-width:180px\"><b>${key}</b></div>
          <div>${val.ar || ''}</div>
          <div class=\"muted\">${val.en || ''}</div>
        </div>
      `).join('');
    }

    function renderSectionSelectors() {
      const sections = currentManifest.sections || {};
      const sectionKeys = Object.keys(sections);
      
      if (sectionKeys.length === 0) return;
      
      // Set default section if none selected
      if (!currentSection) {
        currentSection = sectionKeys[0];
      }
      
      // Render section selector buttons
      const sectionSelector = document.getElementById('sectionSelector');
      if (sectionSelector) {
        sectionSelector.innerHTML = sectionKeys.map(key => `
          <button class="section-btn ${key === currentSection ? 'active' : ''}" data-section="${key}">
            ${sections[key].en || sections[key].ar || key}
          </button>
        `).join('');
        
        // Add event listeners to section buttons
        sectionSelector.querySelectorAll('.section-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            sectionSelector.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSection = btn.dataset.section;
            renderItems();
          });
        });
      }
      
      // Render form section dropdown
      const formSection = document.getElementById('formSection');
      if (formSection) {
        formSection.innerHTML = sectionKeys.map(key => `
          <option value="${key}" ${key === currentSection ? 'selected' : ''}>
            ${sections[key].en || sections[key].ar || key}
          </option>
        `).join('');
      }
    }

    async function addOrUpdateSection() {
      const key = document.getElementById('secKey').value.trim();
      const ar = document.getElementById('secAr').value.trim();
      const en = document.getElementById('secEn').value.trim();
      if (!key) { showMessage('secMsg','‚ùå Enter section key','error'); return; }
      try{
        await api('/api/admin/save-item', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ newSection: key, sectionLabelAr: ar, sectionLabelEn: en }) });
        currentManifest = await api('/api/admin/manifest');
        renderSectionsList();
        renderSectionSelectors();
        updateOverviewStats();
        showMessage('secMsg','‚úÖ Section added/updated','success');
      }catch(e){ showMessage('secMsg','‚ùå Failed: '+e.message,'error'); }
    }

    async function deleteSection() {
      const key = document.getElementById('secKey').value.trim();
      if (!key) { showMessage('secMsg','‚ùå Enter section key','error'); return; }
      if (!confirm('Delete this section and its items?')) return;
      try{
        await api('/api/admin/save-item', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ section: key, deleteSection: true }) });
        currentManifest = await api('/api/admin/manifest');
        renderSectionsList();
        renderSectionSelectors();
        updateOverviewStats();
        showMessage('secMsg','‚úÖ Section deleted','success');
      }catch(e){ showMessage('secMsg','‚ùå Failed: '+e.message,'error'); }
    }

    function updateSelectedFiles() {
      const files = document.getElementById('fileInput').files;
      const container = document.getElementById('selectedFiles');
      const list = document.getElementById('filesList');

      if (files.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      list.innerHTML = Array.from(files).map(file => `
        <div style="padding: 8px; background: var(--border-light); border-radius: 6px; margin-bottom: 4px; font-size: 0.875rem;">
          üì∑ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
        </div>
      `).join('');
    }

    async function saveItem() {
      const saveBtn = document.getElementById('btnSave');
      const originalText = saveBtn.textContent;
      
      try {
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        const section = document.getElementById('formSection').value;
        const item = {
          id: document.getElementById('formId').value.trim(),
          arName: document.getElementById('formArName').value.trim(),
          enName: document.getElementById('formEnName').value.trim(),
          descriptionAr: document.getElementById('formDescAr').value.trim(),
          descriptionEn: document.getElementById('formDescEn').value.trim(),
          price: document.getElementById('formPrice').value.trim(),
          badge: document.getElementById('formBadge').value.trim(),
          images: document.getElementById('formImages').value
            .split(',')
            .map(s => s.trim())
            .filter(Boolean)
        };

        if (!item.id) {
          throw new Error('Item ID is required');
        }

        await api('/api/admin/save-item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ section, item })
        });

        // Refresh data
        currentManifest = await api('/api/admin/manifest');
        updateOverviewStats();
        renderItems();

        showMessage('saveMsg', '‚úÖ Item saved successfully!', 'success');

      } catch (error) {
        showMessage('saveMsg', `‚ùå Error: ${error.message}`, 'error');
      } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }

    async function suggestWithAI() {
      const suggestBtn = document.getElementById('btnSuggest');
      const originalText = suggestBtn.textContent;
      
      try {
        const name = document.getElementById('formArName').value || 
                    document.getElementById('formEnName').value || 
                    document.getElementById('formId').value;
        const section = document.getElementById('formSection').value;

        if (!name) {
          showMessage('saveMsg', '‚ùå Enter item name first to use AI', 'error');
          return;
        }

        suggestBtn.textContent = 'ü§ñ AI Working...';
        suggestBtn.disabled = true;

        const response = await fetch('/api/ai/suggest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, section })
        });

        const data = await response.json();

        if (response.ok) {
          if (data.arName) document.getElementById('formArName').value = data.arName;
          if (data.enName) document.getElementById('formEnName').value = data.enName;
          if (data.ar) document.getElementById('formDescAr').value = data.ar;
          if (data.en) document.getElementById('formDescEn').value = data.en;
          showMessage('saveMsg', '‚úÖ AI suggestions applied!', 'success');
        } else {
          throw new Error(data.error || 'AI request failed');
        }

      } catch (error) {
        showMessage('saveMsg', `‚ùå AI Error: ${error.message}`, 'error');
      } finally {
        suggestBtn.textContent = originalText;
        suggestBtn.disabled = false;
      }
    }

    function clearForm() {
      document.getElementById('formId').value = '';
      document.getElementById('formArName').value = '';
      document.getElementById('formEnName').value = '';
      document.getElementById('formDescAr').value = '';
      document.getElementById('formDescEn').value = '';
      document.getElementById('formPrice').value = '';
      document.getElementById('formBadge').value = '';
      document.getElementById('formImages').value = '';
      showMessage('saveMsg', 'Form cleared', 'info');
    }

    async function uploadImages() {
      const uploadBtn = document.getElementById('btnUpload');
      const originalText = uploadBtn.textContent;
      
      try {
        const files = document.getElementById('fileInput').files;
        const section = document.getElementById('uploadSection').value;

        if (!files.length) {
          showMessage('uploadMsg', '‚ùå Please select images first', 'error');
          return;
        }

        uploadBtn.textContent = 'üì§ Uploading...';
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('section', section);
        Array.from(files).forEach(file => formData.append('files', file));

        const response = await fetch('/api/admin/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.text();

        if (response.ok) {
          showMessage('uploadMsg', `‚úÖ Uploaded: ${result}`, 'success');
          clearFiles();
        } else {
          throw new Error(result);
        }

      } catch (error) {
        showMessage('uploadMsg', `‚ùå Upload failed: ${error.message}`, 'error');
      } finally {
        uploadBtn.textContent = originalText;
        uploadBtn.disabled = false;
      }
    }

    function clearFiles() {
      document.getElementById('fileInput').value = '';
      document.getElementById('selectedFiles').classList.add('hidden');
    }

    function loadSelectedItem() {
      if (!selectedItemId) {
        showMessage('tableMsg', '‚ùå Select an item first', 'error');
        return;
      }

      const items = currentManifest.sections?.[currentSection]?.items || [];
      const item = items.find(i => i.id === selectedItemId);

      if (!item) {
        showMessage('tableMsg', '‚ùå Item not found', 'error');
        return;
      }

      // Switch to editor tab
      switchTab('editor');

      // Fill form
      document.getElementById('formSection').value = currentSection;
      document.getElementById('formId').value = item.id || '';
      document.getElementById('formArName').value = item.arName || '';
      document.getElementById('formEnName').value = item.enName || '';
      document.getElementById('formDescAr').value = item.descriptionAr || '';
      document.getElementById('formDescEn').value = item.descriptionEn || '';
      document.getElementById('formPrice').value = item.price || '';
      document.getElementById('formBadge').value = item.badge || '';
      document.getElementById('formImages').value = (item.images || []).join(', ');

      showMessage('saveMsg', '‚úÖ Item loaded for editing', 'success');
    }

    async function deleteSelectedItem() {
      if (!selectedItemId) {
        showMessage('tableMsg', '‚ùå Select an item first', 'error');
        return;
      }

      if (!confirm('Are you sure you want to delete this item?')) {
        return;
      }

      try {
        await api('/api/admin/save-item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            section: currentSection,
            item: { id: selectedItemId, _delete: true }
          })
        });

        // Refresh data
        currentManifest = await api('/api/admin/manifest');
        updateOverviewStats();
        renderItems();
        selectedItemId = null;

        showMessage('tableMsg', '‚úÖ Item deleted successfully', 'success');

      } catch (error) {
        showMessage('tableMsg', `‚ùå Delete failed: ${error.message}`, 'error');
      }
    }

    async function logout() {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        location.href = '/admin/';
      } catch (error) {
        console.error('Logout failed:', error);
        location.href = '/admin/';
      }
    }

    // Initialize app when page loads
    init();
  </script>
</body>
</html>